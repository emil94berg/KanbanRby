@page "/sharedKanbans"
@using KanbanRby.Components.Popups
@using KanbanRby.Models
@using KanbanRby.Services.Interfaces
@using KanbanRby.Sessions.Interfaces
@using TaskModel = KanbanRby.Models.Task
@using Task = Task
@inject IKanbanBoardService KanbanService
@inject IColumnManagerService ColumnService
@inject ICardManagementService CardService
@inject ITaskManagementService TaskService
@inject IUserSession UserSession
@rendermode InteractiveServer

<PageTitle>Shared Kanbans</PageTitle>

<div class="kanban-page">
    @if (_boards == null)
    {
        <div class="loading-state">
            <strong>Loading...</strong>
        </div>
    }
    else if (!_boards.Any())
    {
        <div class="kanban-header">
            <h3>Shared Kanbans</h3>
        </div>
        <div class="empty-state">
            <p>You have not been invited to any boards yet!</p>
        </div>
    }
    else
    {
        <div class="kanban-header">
            <h3>Shared Kanbans</h3>
            <h1>@_selectedBoard?.Name</h1>
            @if (IsLoggedIn)
            {
                @if (@UserSession.CurrentUser.UserMetadata.ContainsKey("display_name"))
                {
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Viewing as: @UserSession.CurrentUser.UserMetadata["display_name"]</p>
                }
                else
                {
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Viewing as: @UserSession.CurrentUser.Email</p>
                }
            }
        </div>

        <div class="board-controls">
            <select class="form-select" @bind="SelectedBoardId">
                @foreach (var board in _boards)
                {
                    <option value="@board.Id">
                        @board.Name
                    </option>
                }
            </select>
            <CreateColumn BoardId="@SelectedBoardId" OnCreate="ReloadPage"></CreateColumn>
        </div>

        <div class="columnContainer">
            @if (_columns.Any())
            {
                @foreach (var column in _columns)
                {
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <strong>@column.Name</strong>
                            <DeleteColumn ColumnId="column.Id" OnDeleted="ReloadPage"></DeleteColumn>
                        </div>
                        @if (_columnCards.TryGetValue(column.Id, out var cards))
                        {
                            @foreach (var card in cards)
                            {
                                <div class="card">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                        <p style="margin: 0; font-weight: 600;">@card.Name</p>
                                        <DeleteCard CardId="card.Id" OnDeleted="ReloadPage"></DeleteCard>
                                    </div>
                                    @if (_cardTasks.TryGetValue(card.Id, out var tasks))
                                    {
                                        @foreach (var task in tasks)
                                        {
                                            <div class="card task">
                                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                                    <p style="margin: 0;">@task.Name</p>
                                                    <DeleteTask TaskId="task.Id" OnDeleted="ReloadPage"></DeleteTask>
                                                </div>
                                            </div>
                                        }
                                    }
                                    <CreateTask CardId="card.Id" OnCreate="ReloadPage"></CreateTask>
                                </div>
                            }
                        }
                        <CreateCard ColumnId="column.Id" OnCreate="ReloadPage"></CreateCard>
                    </div>
                }
            }
            else
            {
                <div class="empty-state">
                    <p>No columns found. Create one to get started!</p>
                </div>
            }
        </div>
    }
</div>

@code {

    private List<Kanban> _boards;
    private List<Column> _columns = new();
    private Dictionary<int, List<Card>> _columnCards = new();
    private Dictionary<int, List<TaskModel>> _cardTasks = new();
    private Kanban? _selectedBoard;
    private bool IsLoggedIn;


    private int _selectedBoardId;

    private int SelectedBoardId
    {
        get => _selectedBoardId;
        set
        {
            if (_selectedBoardId != value)
            {
                _selectedBoardId = value;
                _selectedBoard = _boards.SingleOrDefault(b => b.Id == _selectedBoardId);
                _ = ReloadPage();
            }
        }

    }


    private async Task LoadColumnsFromSelectedBoard()
    {
        if (_selectedBoard != null)
        {
            _columns = await ColumnService.GetColumnsByKanbanIdAsync(_selectedBoard.Id);
            _columnCards.Clear();
            _cardTasks.Clear();
            foreach (var column in _columns)
            {
                var cards = await CardService.GetAllCardsByColumnIdAsync(column.Id);
                _columnCards[column.Id] = cards;
                foreach (var card in cards)
                {
                    var tasks = await TaskService.GetTasksByCardId(card.Id);
                    _cardTasks[card.Id] = tasks;
                }

            }
        }
    }

    private async Task ReloadPage()
    {
        await LoadColumnsFromSelectedBoard();
        StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        await UserSession.RefreshUserAsync();
        IsLoggedIn = await UserSession.IsLoggedInAsync();
        _selectedBoardId = 1;
        if (UserSession.CurrentUser != null)
        {
            _boards = await KanbanService.GetSharedKanbansAsync(UserSession.CurrentUser.Id);
        }
        else
        {
            _boards = await KanbanService.GetAllAsync();
        }

        if (_boards.Any())
        {
            SelectedBoardId = _boards.First().Id;
            await LoadColumnsFromSelectedBoard();
        }

        UserSession.OnChange += StateHasChanged;
    }

    public void Dispose()
    {
        UserSession.OnChange -= StateHasChanged;
    }

}