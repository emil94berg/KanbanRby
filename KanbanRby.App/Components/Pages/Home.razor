@page "/"
@using KanbanRby.Sessions.Interfaces
@inject IUserSession UserSession
@inject NavigationManager NavManager
@rendermode InteractiveServer

<PageTitle>Home</PageTitle>

@* Logged in view *@
@if (IsLoggedIn)
{
    <div class="p-5 mb-4 bg-light rounded-3">
        <div class="container-fluid py-5">
            <h1 class="display-5 fw-bold">Welcome back, @DisplayNameOrEmail!</h1>
            <p class="col-md-8 fs-4">You are currently signed in. Click below to view and manage your existing Kanban boards.</p>
            
            <button class="btn btn-primary btn-lg" @onclick="NavigateToMyKanbans">Go to My Kanbans</button>
        </div>
    </div>
}

@* Guest/logged out view *@
else
{
    <div class="jumbotron">
        <h1 class="display-4">Welcome to Kanban Viewer!</h1>
        <p class="lead">A simple and effective way to manage your tasks using Kanban boards.</p>
        <hr class="my-4">

        <div>
            <div class="col-md-4">
                <h2>Track Everything</h2>
                <p>Visualize your workflow with custom columns. From 'To Do' to 'Done', see where every task stands instantly.</p>
            </div>
            <div class="col-md-4">
                <h2>Collaborate Easily</h2>
                <p>Invite team members, assign tasks, and keep everyone on the same page. Real-time updates included!</p>
            </div>
        </div>
        <hr>

        <h3>Get Started in 3 Steps:</h3>
        <ol>
            <li>Create an Account: Sign up in seconds using the button below.</li>
            <li>Create a Board: Set up your first project board and columns.</li>
            <li>Add Tasks: Start organizing your work and collaborate!</li>
        </ol>
        <hr class="my-4">
        <p>To start organizing your projects, please log in or create an account.</p>
        <button class="btn btn-primary btn-lg me-2" @onclick="NavigateToRegisterAccount">Create Account</button>
    </div>
}


@code {
    private bool IsLoggedIn;
    
    private string DisplayNameOrEmail =>
        (UserSession.CurrentUser != null &&
         UserSession.CurrentUser.UserMetadata.ContainsKey("display_name") &&
         UserSession.CurrentUser.UserMetadata["display_name"] != null)
            ? UserSession.CurrentUser.UserMetadata["display_name"]!.ToString()!
            : UserSession.CurrentUser?.Email ?? "User";
    

    protected override async Task OnInitializedAsync()
    {
        await UserSession.RefreshUserAsync();
        IsLoggedIn = await UserSession.IsLoggedInAsync();
        UserSession.OnChange += StateHasChanged;
    }

    private void NavigateToRegisterAccount()
    {
        NavManager.NavigateTo("/registerAccount");
    }

    private void NavigateToMyKanbans()
    {
        NavManager.NavigateTo("/myKanbans");
    }

    public void Dispose()
    {
        UserSession.OnChange -= StateHasChanged;
    }
}