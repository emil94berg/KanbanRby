@using KanbanRby.Models
@rendermode InteractiveServer
@using Sessions.Interfaces
@inject IUserSession UserSession
@using Services.Interfaces
@using Task = System.Threading.Tasks.Task
@inject ICardManagementService CardService

@if (IsLoggedIn)
{
    <button class="btn btn-sm btn-secondary" style="margin: 2px color: white" @onclick="MoveUp" disabled="@(!CanMoveUp || isLoading)">↑</button>
    <button class="btn btn-sm btn-secondary" style="margin: 2px color: white" @onclick="MoveDown" disabled="@(!CanMoveDown || isLoading)">↓</button>
    
    @code {
        [Parameter]
        public int CardId { get; set; }
        
        [Parameter]
        public int ColumnId { get; set; }
        
        [Parameter]
        public List<Card> ColumnCards { get; set; } = new();
        
        [Parameter]
        public EventCallback OnMoved { get; set; }
        
        private bool IsLoggedIn;
        private bool isLoading = false;
        private bool CanMoveUp => ColumnCards.Any() && ColumnCards.OrderBy(c => c.RowId).First().Id != CardId;
        private bool CanMoveDown => ColumnCards.Any() && ColumnCards.OrderBy(c => c.RowId).Last().Id != CardId;
        
        private async Task MoveUp()
        {
            isLoading = true;
            try
            {
                await CardService.ChangeOrderOfCardsAsync(CardId, -1, ColumnCards);
                await OnMoved.InvokeAsync();
                await Task.Delay(1500);
            }
            catch(Exception e)
            {
                Console.WriteLine(e.Message);
            }
            finally
            {
                isLoading = false;
            }
        }

        private async Task MoveDown()
        {
            isLoading = true;
            try
            {
                await CardService.ChangeOrderOfCardsAsync(CardId, 1, ColumnCards);
                await OnMoved.InvokeAsync();
            }
            catch(Exception e)
            {
                Console.WriteLine(e.Message);
            }
            finally
            {
                isLoading = false;
            }
        }

        protected override async Task OnInitializedAsync()
        {
            IsLoggedIn = await UserSession.IsLoggedInAsync();
        }
    }
}
