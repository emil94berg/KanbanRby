@using KanbanRby.Models
@rendermode InteractiveServer
@using Sessions.Interfaces
@inject IUserSession UserSession
@using Services.Interfaces
@using Task = System.Threading.Tasks.Task
@inject ITaskManagementService TaskService

@if (IsLoggedIn)
{
    <button class="btn btn-sm btn-outline-danger" style="margin: 2px" @onclick="ShowPopup">Delete</button>
    @if (isPopupVisible)
    {
        <div class="popup-overlay">
            <div class="popup-content" @onabort:stopPropagation="true">
                <h3>Delete Task</h3>
                <p>Are you sure you want to delete this task? This action cannot be undone.</p>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-danger" @onclick="DeleteAndClosePopup">Delete</button>
                    <button class="btn btn-secondary" @onclick="ClosePopup">Cancel</button>
                </div>
            </div>
        </div>
    }
    @code {
        [Parameter]
        public int TaskId { get; set; }
        
        [Parameter]
        public EventCallback OnDeleted { get; set; }
        
        private bool isPopupVisible = false;
        private bool IsLoggedIn;
        
        private void ShowPopup()
        {
            isPopupVisible = true;
        }

        private void ClosePopup()
        {
            isPopupVisible = false;
        }

        private async Task DeleteAndClosePopup()
        {
            try
            {
                await TaskService.DeleteTaskAsync(TaskId);
                await OnDeleted.InvokeAsync();
            }
            catch(Exception e)
            {
                Console.WriteLine(e.Message);
            }
            
            isPopupVisible = false;
        }

        protected override async Task OnInitializedAsync()
        {
            IsLoggedIn = await UserSession.IsLoggedInAsync();
        }
    }
}
