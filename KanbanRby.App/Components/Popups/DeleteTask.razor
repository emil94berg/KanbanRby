@using KanbanRby.Models
@rendermode InteractiveServer
@using Sessions.Interfaces
@inject IUserSession UserSession
@using Services.Interfaces
@using Task = System.Threading.Tasks.Task
@inject ITaskManagementService TaskService

@if (IsLoggedIn)
{
    <button class="btn btn-sm btn-outline-danger" style="margin: 2px" @onclick="ShowPopup">Delete</button>
    @if (isPopupVisible)
    {
        <div class="popup-overlay" @onclick="ClosePopup">
            <div class="popup-content" @onclick:stopPropagation="true">
                <h3>Delete Task</h3>
                <p style="margin-bottom: 1.5rem; color: #555; font-size: 1rem;">Are you sure you want to delete this task? This action cannot be undone.</p>
                <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
                    <button class="btn btn-secondary" @onclick="ClosePopup" disabled="@isLoading">Cancel</button>
                    <button class="btn btn-danger" @onclick="DeleteAndClosePopup" disabled="@isLoading">@(isLoading ? "Deleting..." : "Delete")</button>
                </div>
            </div>
        </div>
    }
}

@code {
    [Parameter]
    public int TaskId { get; set; }
    
    [Parameter]
    public int CardId { get; set; }
    
    [Parameter]
    public EventCallback OnDeleted { get; set; }
    
    private bool isPopupVisible = false;
    private bool IsLoggedIn;
    private bool isLoading = false;
    
    private void ShowPopup()
    {
        isPopupVisible = true;
    }

    private void ClosePopup()
    {
        isPopupVisible = false;
    }

    private async Task DeleteAndClosePopup()
    {
        isLoading = true;
        try
        {
            await TaskService.DeleteTaskAsync(TaskId);
            await TaskService.ReorderTasksInCardAsync(CardId);
            await OnDeleted.InvokeAsync();
        }
        catch(Exception e)
        {
            Console.WriteLine(e.Message);
        }
        finally
        {
            isLoading = false;
        }
        
        isPopupVisible = false;
    }

    protected override async Task OnInitializedAsync()
    {
        IsLoggedIn = await UserSession.IsLoggedInAsync();
    }
}
