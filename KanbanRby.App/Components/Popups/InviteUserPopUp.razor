@using KanbanRby.Models
@using KanbanRby.Services.Interfaces
@using KanbanRby.Sessions.Interfaces
@using Task = System.Threading.Tasks.Task
@inject IUserSession UserSession
@inject ISupabaseProfileService ProfileService
@inject IKanbanInviteUserService InviteUserService
@rendermode InteractiveServer

@if (IsLoggedIn)
{
    <button class="btn btn-primary" style="margin: 2px" @onclick="ShowPopUp">Invite User</button>
    if (isPopUpVisible)
    {
        <div class="popup-overlay" @onclick="HidePopUp">
            <div class="popup-content" @onclick:stopPropagation="true">
                <label>Search for display name or email: </label>
                <InputText @bind-Value="searchQuery" @bind-Value:after="OnSearchQueryChanged"></InputText>
                <select class="form-select" @bind="selectedUserId">
                    <option value="">-- Select a user --</option>
                    @foreach (var user in allProfiles.Where(s =>s.displayName.Contains(searchQuery) || s.email.Contains(searchQuery)))
                    {
                        <option value="@user.id">Email: @user.email Display Name: @user.displayName</option>
                    }
                </select>
                <button class="btn btn-secondary" @onclick="HidePopUp">Close</button>
                <button class="btn btn-success" @onclick="InviteUser">Invite</button>
            </div>
        </div>
    }
}

@code {
    private bool IsLoggedIn;
    private bool isPopUpVisible = false;
    private string selectedUserId = "";
    List<PublicProfile> allProfiles;
    private string searchQuery = "";
    [Parameter]
    public Kanban selectedKanban { get; set; }

    private void ShowPopUp()
    {
        isPopUpVisible = true;
    }

    private void HidePopUp()
    {
        isPopUpVisible = false;
    }

    private void OnSearchQueryChanged()
    {
        // Reset selection when search query changes to prevent selecting a user that's no longer visible
        if (!string.IsNullOrEmpty(selectedUserId) && Guid.TryParse(selectedUserId, out var guid))
        {
            var filteredUsers = allProfiles.Where(s => s.displayName.Contains(searchQuery) || s.email.Contains(searchQuery)).ToList();
            if (!filteredUsers.Any(u => u.id == guid))
            {
                selectedUserId = "";
            }
        }
    }

    private async Task InviteUser()
    {
        if (string.IsNullOrEmpty(selectedUserId) || !Guid.TryParse(selectedUserId, out var userId))
        {
            // Should display a popup if something goes wrong
            return;
        }
        
        var kanbanUserInvite = new KanbanUser() { UserId = userId, KanbanId = selectedKanban.Id};
        await InviteUserService.CreateKanbanUser(kanbanUserInvite);
        HidePopUp();
    }
    
    protected override async Task OnInitializedAsync()
    {
        IsLoggedIn = await UserSession.IsLoggedInAsync();
        allProfiles = await ProfileService.GetAllProfiles();
    }
}